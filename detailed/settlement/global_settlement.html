<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Global Settlement - ZAI docs</title>


        <!-- Custom HTML head -->
        
        <!-- Fonts -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
        href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600;700;800&family=Rubik:ital,wght@0,400;0,700;0,800;1,600&display=swap"
        rel="stylesheet"
        />
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <span class="logo" ></span>
                <ol class="chapter"><li class="chapter-item expanded "><a href="../../index.html"><strong aria-hidden="true">1.</strong> Home</a></li><li class="chapter-item expanded affix "><li class="part-title">Documentation</li><li class="chapter-item expanded "><a href="../../detailed/intro/index.html"><strong aria-hidden="true">2.</strong> ❱ Getting Started</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../detailed/intro/hai.html"><strong aria-hidden="true">2.1.</strong> Introduction to ZAI</a></li><li class="chapter-item expanded "><a href="../../detailed/intro/protocol.html"><strong aria-hidden="true">2.2.</strong> Azos Protocol 101</a></li></ol></li><li class="chapter-item expanded "><a href="../../detailed/modules/index.html"><strong aria-hidden="true">3.</strong> ❱ Core Modules</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../detailed/modules/safe_engine.html"><strong aria-hidden="true">3.1.</strong> SAFE Engine</a></li><li class="chapter-item expanded "><a href="../../detailed/modules/acc_engine.html"><strong aria-hidden="true">3.2.</strong> Accounting Engine</a></li><li class="chapter-item expanded "><a href="../../detailed/modules/liq_engine.html"><strong aria-hidden="true">3.3.</strong> Liquidation Engine</a></li><li class="chapter-item expanded "><a href="../../detailed/modules/oracle_relayer.html"><strong aria-hidden="true">3.4.</strong> Oracle Relayer</a></li><li class="chapter-item expanded "><a href="../../detailed/modules/tax_collector.html"><strong aria-hidden="true">3.5.</strong> Tax Collector</a></li><li class="chapter-item expanded "><a href="../../detailed/modules/pid_controller.html"><strong aria-hidden="true">3.6.</strong> PID Controller</a></li><li class="chapter-item expanded "><a href="../../detailed/modules/sf_treasury.html"><strong aria-hidden="true">3.7.</strong> Stability Fee Treasury</a></li></ol></li><li class="chapter-item expanded "><a href="../../detailed/auctions/index.html"><strong aria-hidden="true">4.</strong> ❱ Auction Houses</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../detailed/auctions/cah.html"><strong aria-hidden="true">4.1.</strong> Collateral Auction House</a></li><li class="chapter-item expanded "><a href="../../detailed/auctions/dah.html"><strong aria-hidden="true">4.2.</strong> Debt Auction House</a></li><li class="chapter-item expanded "><a href="../../detailed/auctions/sah.html"><strong aria-hidden="true">4.3.</strong> Surplus Auction House</a></li></ol></li><li class="chapter-item expanded "><a href="../../detailed/settlement/index.html"><strong aria-hidden="true">5.</strong> ❱ Settlement</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../detailed/settlement/global_settlement.html" class="active"><strong aria-hidden="true">5.1.</strong> Global Settlement</a></li><li class="chapter-item expanded "><a href="../../detailed/settlement/ps_sah.html"><strong aria-hidden="true">5.2.</strong> Post Settlement Surplus Auction House</a></li><li class="chapter-item expanded "><a href="../../detailed/settlement/ps_surplus_actioneer.html"><strong aria-hidden="true">5.3.</strong> Settlement Surplus Actioneer</a></li></ol></li><li class="chapter-item expanded "><a href="../../detailed/tokens/index.html"><strong aria-hidden="true">6.</strong> ❱ Tokens & Utils</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../detailed/tokens/system_coin.html"><strong aria-hidden="true">6.1.</strong> System Coin</a></li><li class="chapter-item expanded "><a href="../../detailed/tokens/protocol_token.html"><strong aria-hidden="true">6.2.</strong> Protocol Token</a></li><li class="chapter-item expanded "><a href="../../detailed/tokens/join_adapter.html"><strong aria-hidden="true">6.3.</strong> Join Adapters</a></li></ol></li><li class="chapter-item expanded "><a href="../../detailed/utils/index.html"><strong aria-hidden="true">7.</strong> ❱ Contract Utils</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../detailed/utils/authorizable.html"><strong aria-hidden="true">7.1.</strong> Authorizable</a></li><li class="chapter-item expanded "><a href="../../detailed/utils/modifiable.html"><strong aria-hidden="true">7.2.</strong> Modifiable</a></li><li class="chapter-item expanded "><a href="../../detailed/utils/disableable.html"><strong aria-hidden="true">7.3.</strong> Disableable</a></li><li class="chapter-item expanded "><a href="../../detailed/utils/factory/index.html"><strong aria-hidden="true">7.4.</strong> ❱ Factories</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../detailed/utils/factory/factory_child.html"><strong aria-hidden="true">7.4.1.</strong> Factory Child</a></li><li class="chapter-item expanded "><a href="../../detailed/utils/factory/authorizable_child.html"><strong aria-hidden="true">7.4.2.</strong> Authorizable Child</a></li><li class="chapter-item expanded "><a href="../../detailed/utils/factory/disableable_child.html"><strong aria-hidden="true">7.4.3.</strong> Disableable Child</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../detailed/proxies/index.html"><strong aria-hidden="true">8.</strong> ❱ Proxy Utils</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../detailed/proxies/hai_proxy.html"><strong aria-hidden="true">8.1.</strong> ZAI Proxy</a></li><li class="chapter-item expanded "><a href="../../detailed/proxies/hai_proxy_factory.html"><strong aria-hidden="true">8.2.</strong> Proxy Factory</a></li><li class="chapter-item expanded "><a href="../../detailed/proxies/hai_safe_manager.html"><strong aria-hidden="true">8.3.</strong> SAFE Manager</a></li><li class="chapter-item expanded "><a href="../../detailed/proxies/actions/index.html"><strong aria-hidden="true">8.4.</strong> ❱ Actions</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../detailed/proxies/actions/basic_actions.html"><strong aria-hidden="true">8.4.1.</strong> Basic Actions</a></li><li class="chapter-item expanded "><a href="../../detailed/proxies/actions/rewarded_actions.html"><strong aria-hidden="true">8.4.2.</strong> Rewarded Actions</a></li><li class="chapter-item expanded "><a href="../../detailed/proxies/actions/bidding_actions.html"><strong aria-hidden="true">8.4.3.</strong> Bidding Actions</a></li><li class="chapter-item expanded "><a href="../../detailed/proxies/actions/settlement_actions.html"><strong aria-hidden="true">8.4.4.</strong> Settlement Actions</a></li></ol></li></ol></li><li class="chapter-item expanded "><li class="part-title">Technical Documentation</li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle"></button>
                        <button id="theme-toggle-light" class="icon-button" type="button" title="Enable light theme" aria-label="Enable light theme">
                          <i class="fa fa-sun-o"></i>
                        </button>
                        <button id="theme-toggle-dark" class="icon-button" type="button" title="Enable dark theme" aria-label="Enable dark theme">
                          <i class="fa fa-moon-o"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="global-settlement"><a class="header" href="#global-settlement">Global Settlement</a></h1>
<p>See <a href="/src/contracts/settlement/GlobalSettlement.sol/contract.GlobalSettlement.html">GlobalSettlement.sol</a> for more details.</p>
<h2 id="1-introduction"><a class="header" href="#1-introduction">1. Introduction</a></h2>
<p>The Global Settlement contract serves as the emergency brake and ultimate wind-down mechanism for the system. Its responsibilities include:</p>
<ul>
<li><strong>Triggering the System Shutdown</strong>: Initiating the process to safely halt all operations.</li>
<li><strong>Processing SAFEs</strong>: Settling all Secure, Automated, Flexible, and Efficient (SAFE) accounts to determine each collateral's deficits and surplus.</li>
<li><strong>Terminating Auctions</strong>: Bringing all ongoing auctions to a premature end, ensuring that assets are no longer tied up.</li>
<li><strong>Calculating Redemption Price</strong>: Determining the value at which system coin holders can redeem their coins for backing collateral.</li>
<li><strong>Redemption</strong>: Enabling system coin holders to exchange their coins for the appropriate collateral, completing the shutdown process.</li>
</ul>
<p>This contract is crucial for ensuring that, in the event of a system shutdown, all parties can walk away with assets that are rightfully theirs, thus maintaining a fair and secure environment.</p>
<h2 id="2-contract-details"><a class="header" href="#2-contract-details">2. Contract Details</a></h2>
<h3 id="key-methods"><a class="header" href="#key-methods">Key Methods:</a></h3>
<p><strong>Public</strong></p>
<ul>
<li><code>freezeCollateralType</code>: Captures the current market price of a specified collateral type and freezes it within the contract. This is crucial for ensuring accurate valuations during the shutdown process.</li>
<li><code>fastTrackAuction</code>: Allows for the immediate termination of ongoing collateral auctions. This function ensures that assets are returned to their rightful owners as quickly as possible during a shutdown.</li>
<li><code>processSAFE</code>: This method is responsible for settling the debts associated with SAFEs and determining any collateral deficit that exists. This ensures that all assets and liabilities are properly accounted for.</li>
<li><code>freeCollateral</code>: Post-processing of SAFEs, this function enables SAFE owners to withdraw any remaining collateral. This ensures that users recover their tied-up assets.</li>
<li><code>setOutstandingCoinSupply</code>: Sets the global coin supply (which also accounts for the system's debt). This is important for calculating how much collateral can be redeemed for each system coin.</li>
<li><code>calculateCashPrice</code>: Determines the price at which system coin holders can redeem their coins for backing collateral. This provides clarity and fairness in the redemption process.</li>
<li><code>prepareCoinsForRedeeming</code>: Allows system coin holders to deposit their coins into the contract in preparation for redemption. This sets the stage for users to reclaim their backing collateral.</li>
<li><code>redeemCollateral</code>: Executes the redemption process, transferring the appropriate amount of collateral to system coin holders who have previously deposited their coins for redemption. This is the final step in the shutdown and asset recovery process.</li>
</ul>
<p><strong>Authorized</strong></p>
<ul>
<li><code>shutdownSystem</code>: This function triggers the system shutdown, initiating all the processes mentioned above. This function can only be executed by an authorized entity.</li>
</ul>
<p>These methods collectively enable a structured and secure way to halt system operations, settle accounts, and distribute assets in the event of a system shutdown.</p>
<h3 id="contract-parameters"><a class="header" href="#contract-parameters">Contract Parameters:</a></h3>
<ul>
<li><strong>Oracle Relayer</strong>: The address used to fetch the redemption price and the collaterals price.</li>
<li><strong>Liquidation Engine</strong>: The address used to fetch the collateral auction houses from each collateral type.</li>
<li><strong>Coin Join</strong>: The Coin Join contract (to disable).</li>
<li><strong>Collateral Join Factory</strong>: The Collateral Join Factory contract (to disable).</li>
<li><strong>Collateral Auction House Factory</strong>: The Collateral Auction House Factory contract (to disable).</li>
<li><strong>Stability Fee Treasury</strong>: The Stability Fee Treasury contract, that needs to be disabled before the Accounting Engine to transfer its funds to it.</li>
<li><strong>Accounting Engine</strong>: The Accounting Engine contract, that tries after disablement to settle as much debt as possible, and transfer the remaining surplus to the post settlement drain account.</li>
<li><code>shutdownCooldown</code>: The amount of time that must pass after the system shutdown is triggered before the outstanding coin supply can be calculated.</li>
</ul>
<h2 id="3-key-mechanisms--concepts"><a class="header" href="#3-key-mechanisms--concepts">3. Key Mechanisms &amp; Concepts</a></h2>
<h3 id="system-shutdown"><a class="header" href="#system-shutdown">System Shutdown</a></h3>
<p>The system shutdown is triggered by calling the <code>shutdownSystem</code> method, that triggers the <code>disableContract</code> method on the disableable contracts (see <a href="/src/contracts/utils/Disableable.sol/contract.Disableable.html">Disableable.sol</a>). Disableable contracts implement the following tools:</p>
<ul>
<li><code>contractEnabled</code>: A boolean flag that indicates whether the contract is enabled or disabled.</li>
<li><code>_onContractDisable</code> method: A routine that is triggered when the contract is disabled.</li>
<li><code>whenEnabled / whenDisabled</code> modifiers: Modifiers that can be used to restrict the execution of a method to when the contract is enabled or disabled.</li>
</ul>
<h3 id="collateral-redemption-price-calculation"><a class="header" href="#collateral-redemption-price-calculation">Collateral Redemption Price Calculation</a></h3>
<p>The <code>calculateCashPrice</code> method plays a critical role in the Global Settlement contract by determining the rate at which each system coin can be redeemed for its underlying collateral. The method employs a complex formula to arrive at this price, ensuring an equitable distribution of collateral assets based on various dynamic factors.</p>
<p>The formula used to calculate the collateral redemption price (<code>collateralCashPrice</code>) is as follows:</p>
<pre><code>collateralCashPrice =
(
    collateralDebt * accumulatedRate / collateralPrice
    - collateralShortfall
) / outstandingCoinSupply
</code></pre>
<p><strong>Where</strong>:</p>
<ul>
<li><code>collateralDebt</code>: Represents the aggregate debt associated with a specific collateral type, generated by SAFEs.</li>
<li><code>accumulatedRate</code>: The total accrued rate (like interest or tax rate) applied to the specific collateral type over time.</li>
<li><code>collateralPrice</code>: The most recent market price for the specific collateral type, usually fetched from a trusted oracle.</li>
<li><code>outstandingCoinSupply</code>: The total circulation of system coins, essentially the aggregate debt of the system.</li>
<li><code>collateralShortfall</code>: Quantifies the deficit in terms of system coins for the collateral type.
<blockquote>
<p>If SAFEs for a particular collateral type are under-collateralized, this value will capture the shortfall. Conversely, if SAFEs are over-collateralized, owners are entitled to withdraw the surplus.</p>
</blockquote>
</li>
</ul>
<h4 id="redemption-mechanism"><a class="header" href="#redemption-mechanism">Redemption Mechanism:</a></h4>
<p>Once the <code>collateralCashPrice</code> is calculated, users can redeem their system coins for the backing collateral using the following formula:</p>
<pre><code>redeemableCollateral = coinAmount * collateralCashPrice
</code></pre>
<p>This ensures that each coin is redeemable for a fair portion of collateral, aiming to clear out both coins and collateral from the system by the end of the Global Settlement process.</p>
<blockquote>
<p><strong>Notice</strong>: The design of this formula is such that by the end of the redemption process, the system should ideally have neither excess coins nor remaining collateral. It provides a balanced mechanism for winding down system operations and returning assets to participants.</p>
</blockquote>
<h2 id="4-gotchas"><a class="header" href="#4-gotchas">4. Gotchas</a></h2>
<h2 id="5-failure-modes"><a class="header" href="#5-failure-modes">5. Failure Modes</a></h2>
<h3 id="parameters-misconfiguration"><a class="header" href="#parameters-misconfiguration">Parameters Misconfiguration</a></h3>
<ul>
<li>A too-low <code>shutdownCooldown</code> risks premature shutdown, leading to inaccurate collateral redemption prices due to incomplete auctions and unprocessed SAFEs.</li>
<li>A too-high <code>shutdownCooldown</code> prolongs the waiting period for users to redeem their coins for backing collateral, causing potential liquidity issues.</li>
</ul>
<h3 id="incorrect-authorizations-or-state"><a class="header" href="#incorrect-authorizations-or-state">Incorrect Authorizations or State</a></h3>
<p>This contract requires to have authorization in the following contracts:</p>
<ul>
<li>SAFEEngine</li>
<li>OracleRelayer</li>
<li>LiquidationEngine</li>
<li>CollateralAuctionHouseFactory</li>
<li>CoinJoin</li>
<li>CollateralJoinFactory</li>
<li>StabilityFeeTreasury</li>
<li>AccountingEngine</li>
</ul>
<p>Should one of this authorizations be missing, the contract will not work as expected, reverting on the <code>shutdownSystem</code> routine.</p>
<p>The routine also requires all above contracts to be enabled. Should one of these contracts have been manually disabled, the routine will revert.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../detailed/settlement/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../../detailed/settlement/ps_sah.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../detailed/settlement/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../../detailed/settlement/ps_sah.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
