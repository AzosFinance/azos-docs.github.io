<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Accounting Engine - ZAI docs</title>


        <!-- Custom HTML head -->
        
        <!-- Fonts -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
        href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600;700;800&family=Rubik:ital,wght@0,400;0,700;0,800;1,600&display=swap"
        rel="stylesheet"
        />
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <span class="logo" ></span>
                <ol class="chapter"><li class="chapter-item expanded "><a href="../../index.html"><strong aria-hidden="true">1.</strong> Home</a></li><li class="chapter-item expanded affix "><li class="part-title">Documentation</li><li class="chapter-item expanded "><a href="../../detailed/intro/index.html"><strong aria-hidden="true">2.</strong> ❱ Getting Started</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../detailed/intro/hai.html"><strong aria-hidden="true">2.1.</strong> Introduction to ZAI</a></li><li class="chapter-item expanded "><a href="../../detailed/intro/protocol.html"><strong aria-hidden="true">2.2.</strong> Azos Protocol 101</a></li></ol></li><li class="chapter-item expanded "><a href="../../detailed/modules/index.html"><strong aria-hidden="true">3.</strong> ❱ Core Modules</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../detailed/modules/safe_engine.html"><strong aria-hidden="true">3.1.</strong> SAFE Engine</a></li><li class="chapter-item expanded "><a href="../../detailed/modules/acc_engine.html" class="active"><strong aria-hidden="true">3.2.</strong> Accounting Engine</a></li><li class="chapter-item expanded "><a href="../../detailed/modules/liq_engine.html"><strong aria-hidden="true">3.3.</strong> Liquidation Engine</a></li><li class="chapter-item expanded "><a href="../../detailed/modules/oracle_relayer.html"><strong aria-hidden="true">3.4.</strong> Oracle Relayer</a></li><li class="chapter-item expanded "><a href="../../detailed/modules/tax_collector.html"><strong aria-hidden="true">3.5.</strong> Tax Collector</a></li><li class="chapter-item expanded "><a href="../../detailed/modules/pid_controller.html"><strong aria-hidden="true">3.6.</strong> PID Controller</a></li><li class="chapter-item expanded "><a href="../../detailed/modules/sf_treasury.html"><strong aria-hidden="true">3.7.</strong> Stability Fee Treasury</a></li></ol></li><li class="chapter-item expanded "><a href="../../detailed/auctions/index.html"><strong aria-hidden="true">4.</strong> ❱ Auction Houses</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../detailed/auctions/cah.html"><strong aria-hidden="true">4.1.</strong> Collateral Auction House</a></li><li class="chapter-item expanded "><a href="../../detailed/auctions/dah.html"><strong aria-hidden="true">4.2.</strong> Debt Auction House</a></li><li class="chapter-item expanded "><a href="../../detailed/auctions/sah.html"><strong aria-hidden="true">4.3.</strong> Surplus Auction House</a></li></ol></li><li class="chapter-item expanded "><a href="../../detailed/settlement/index.html"><strong aria-hidden="true">5.</strong> ❱ Settlement</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../detailed/settlement/global_settlement.html"><strong aria-hidden="true">5.1.</strong> Global Settlement</a></li><li class="chapter-item expanded "><a href="../../detailed/settlement/ps_sah.html"><strong aria-hidden="true">5.2.</strong> Post Settlement Surplus Auction House</a></li><li class="chapter-item expanded "><a href="../../detailed/settlement/ps_surplus_actioneer.html"><strong aria-hidden="true">5.3.</strong> Settlement Surplus Actioneer</a></li></ol></li><li class="chapter-item expanded "><a href="../../detailed/tokens/index.html"><strong aria-hidden="true">6.</strong> ❱ Tokens & Utils</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../detailed/tokens/system_coin.html"><strong aria-hidden="true">6.1.</strong> System Coin</a></li><li class="chapter-item expanded "><a href="../../detailed/tokens/protocol_token.html"><strong aria-hidden="true">6.2.</strong> Protocol Token</a></li><li class="chapter-item expanded "><a href="../../detailed/tokens/join_adapter.html"><strong aria-hidden="true">6.3.</strong> Join Adapters</a></li></ol></li><li class="chapter-item expanded "><a href="../../detailed/utils/index.html"><strong aria-hidden="true">7.</strong> ❱ Contract Utils</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../detailed/utils/authorizable.html"><strong aria-hidden="true">7.1.</strong> Authorizable</a></li><li class="chapter-item expanded "><a href="../../detailed/utils/modifiable.html"><strong aria-hidden="true">7.2.</strong> Modifiable</a></li><li class="chapter-item expanded "><a href="../../detailed/utils/disableable.html"><strong aria-hidden="true">7.3.</strong> Disableable</a></li><li class="chapter-item expanded "><a href="../../detailed/utils/factory/index.html"><strong aria-hidden="true">7.4.</strong> ❱ Factories</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../detailed/utils/factory/factory_child.html"><strong aria-hidden="true">7.4.1.</strong> Factory Child</a></li><li class="chapter-item expanded "><a href="../../detailed/utils/factory/authorizable_child.html"><strong aria-hidden="true">7.4.2.</strong> Authorizable Child</a></li><li class="chapter-item expanded "><a href="../../detailed/utils/factory/disableable_child.html"><strong aria-hidden="true">7.4.3.</strong> Disableable Child</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../detailed/proxies/index.html"><strong aria-hidden="true">8.</strong> ❱ Proxy Utils</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../detailed/proxies/hai_proxy.html"><strong aria-hidden="true">8.1.</strong> ZAI Proxy</a></li><li class="chapter-item expanded "><a href="../../detailed/proxies/hai_proxy_factory.html"><strong aria-hidden="true">8.2.</strong> Proxy Factory</a></li><li class="chapter-item expanded "><a href="../../detailed/proxies/hai_safe_manager.html"><strong aria-hidden="true">8.3.</strong> SAFE Manager</a></li><li class="chapter-item expanded "><a href="../../detailed/proxies/actions/index.html"><strong aria-hidden="true">8.4.</strong> ❱ Actions</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../detailed/proxies/actions/basic_actions.html"><strong aria-hidden="true">8.4.1.</strong> Basic Actions</a></li><li class="chapter-item expanded "><a href="../../detailed/proxies/actions/rewarded_actions.html"><strong aria-hidden="true">8.4.2.</strong> Rewarded Actions</a></li><li class="chapter-item expanded "><a href="../../detailed/proxies/actions/bidding_actions.html"><strong aria-hidden="true">8.4.3.</strong> Bidding Actions</a></li><li class="chapter-item expanded "><a href="../../detailed/proxies/actions/settlement_actions.html"><strong aria-hidden="true">8.4.4.</strong> Settlement Actions</a></li></ol></li></ol></li><li class="chapter-item expanded "><li class="part-title">Technical Documentation</li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle"></button>
                        <button id="theme-toggle-light" class="icon-button" type="button" title="Enable light theme" aria-label="Enable light theme">
                          <i class="fa fa-sun-o"></i>
                        </button>
                        <button id="theme-toggle-dark" class="icon-button" type="button" title="Enable dark theme" aria-label="Enable dark theme">
                          <i class="fa fa-moon-o"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="accounting-engine"><a class="header" href="#accounting-engine">Accounting Engine</a></h1>
<p>See <a href="/src/contracts/AccountingEngine.sol/contract.AccountingEngine.html">AccountingEngine.sol</a> for more details.</p>
<h2 id="1-introduction"><a class="header" href="#1-introduction">1. Introduction</a></h2>
<p>The Accounting Engine serves as the system's financial management hub, overseeing tasks such as:</p>
<ul>
<li>Tracking system surplus and deficit.</li>
<li>Managing system debt through auctions.</li>
<li>Dealing with system surplus via auctions or transfers.</li>
<li>Accepting COINs (for instance, from auctions) and using them to offset DEBT.</li>
</ul>
<h2 id="2-contract-details"><a class="header" href="#2-contract-details">2. Contract Details</a></h2>
<h3 id="key-methods"><a class="header" href="#key-methods">Key Methods:</a></h3>
<p><strong>Public</strong></p>
<ul>
<li><code>popDebtFromQueue</code>: Removes a certain amount of debt from the time-sensitive queue after the <code>popDebtDelay</code> duration has elapsed, for either settlement or auction.</li>
<li><code>settleDebt</code>: Utilizes coin balance to settle debt.</li>
<li><code>cancelAuctionedDebtWithSurplus</code>: Utilizes coins to settle debt that's in the queue.</li>
<li><code>auctionDebt</code>: Triggers an auction to liquidate portions of unsettled debt.</li>
<li><code>auctionSurplus</code>: Triggers an auction to liquidate surplus once all debt has been settled.</li>
<li><code>transferExtraSurplus</code>: Allocates (instead of auctioning it) excess surplus following debt settlement.</li>
<li><code>transferPostSettlementSurplus</code>: Allocates all remaining surplus when a Global Settlement event occurs.</li>
</ul>
<p><strong>Authorized</strong></p>
<ul>
<li><code>pushDebtToQueue</code>: Adds a specified amount of debt to a time-sensitive queue.</li>
<li><code>disableContract</code>: Deactivates both Debt and Surplus Auction Houses, clears as much debt as possible, and transfers (after <code>disableCooldown</code> delay) any leftover surplus to a designated drain address.</li>
</ul>
<h3 id="required-authorities"><a class="header" href="#required-authorities">Required Authorities:</a></h3>
<ul>
<li><strong>LiquidationEngine</strong>: needs authorization to call <code>pushDebtToQueue</code>.</li>
<li><strong>Debt Auction House</strong>: needs authorization to call <code>cancelAuctionedDebtWithSurplus</code>.</li>
<li><strong>Surplus Auction House</strong>: needs approval to modify the contract's state in the SAFE Engine.</li>
<li><strong>Global Settlement</strong>: needs authorization to call <code>disableContract</code>.</li>
</ul>
<h3 id="contract-parameters"><a class="header" href="#contract-parameters">Contract Parameters:</a></h3>
<p><strong>Global</strong></p>
<ul>
<li><strong>SAFE Engine</strong>: Holds the coin and debt balance, is called to settle debt.</li>
<li><strong>Surplus Auction House</strong>: Is called to start surplus auctions.</li>
<li><strong>Debt Auction House</strong>: Is called to start debt auctions.</li>
<li><code>postSettlementSurplusDrain</code>: Address to which surplus is sent following Global Settlement.</li>
<li><code>surplusIsTransferred</code>: Whether the surplus should be either auctioned off or transferred.</li>
<li><code>surplusDelay</code>: Time lag before the surplus becomes eligible for either auction or transfer.</li>
<li><code>popDebtDelay</code>: Time interval after which debt can be popped from the time-sensitive queue.</li>
<li><code>disableCooldown</code>: The waiting period following Global Settlement, after which any remaining surplus should be transferred.</li>
<li><code>surplusAmount</code>: Amount of surplus eligible for auction or transfer during each operation.</li>
<li><code>surplusBuffer</code>: Minimum surplus reserve to be maintained in the contract following an auction or transfer.</li>
<li><code>debtAuctionMintedTokens</code>: Initial quantity of Protocol Tokens offered for minting in debt auctions.</li>
<li><code>debtAuctionBidSize</code>: Chunk of debt that can be offered in each individual debt auction.</li>
</ul>
<h2 id="3-key-mechanisms--concepts"><a class="header" href="#3-key-mechanisms--concepts">3. Key Mechanisms &amp; Concepts</a></h2>
<h3 id="queued-debt-on-auction-debt--unqueued-unauctioned-debt"><a class="header" href="#queued-debt-on-auction-debt--unqueued-unauctioned-debt">Queued Debt, On Auction Debt &amp; Unqueued Unauctioned Debt</a></h3>
<p>Within the SAFE Engine's scope, the Accounting Engine maintains a single debt balance associated with the contract address. This balance is the summation of three components: the queued debt, representing debt in line for auctioning; the unqueued debt, which is currently being auctioned; and the remaining debt not undergoing auction at the moment.</p>
<p>The unqueued-unauctioned debt can be calculated as follows:</p>
<pre><code>unqueuedUnauctionedDebt = debtBalance - queuedDebt - onAuctionDebt
</code></pre>
<p>Once the <code>unqueuedUnauctionedDebt</code> debt reaches the specified <code>debtAuctionBidSize</code> threshold and the cooldown period elapses, a debt auction is initiated. During this process, the overall debt of the contract remains unchanged, but the <code>onAuctionDebt</code> metric increases as the debt enters the auction phase. Simultaneously, the calculation for <code>unqueuedUnauctionedDebt</code> decreases as the debt undergoing auction is accounted for.</p>
<h2 id="4-gotchas"><a class="header" href="#4-gotchas">4. Gotchas</a></h2>
<h3 id="unqueued-unauctioned-debt-underflow"><a class="header" href="#unqueued-unauctioned-debt-underflow">Unqueued Unauctioned Debt underflow</a></h3>
<p>The <code>queuedDebt</code> is modified through the <code>pushDebtToQueue</code> (authorized) and <code>popDebtFromQueue</code> (public) methods. They don't exclusively mirror the <code>debtBalance</code> recorded in the SAFE Engine. If an authorized contract uses <code>pushDebtToQueue</code> without transferring debt to the Accounting Engine, it could lead to an underflow issue (if <code>queuedDebt</code> exceeds <code>debtBalance</code>). This situation could potentially disrupt the contract's ability to auction debt as the <code>unqueuedUnauctionedDebt</code> calculation might underflow and revert.</p>
<h2 id="5-failure-modes"><a class="header" href="#5-failure-modes">5. Failure Modes</a></h2>
<h3 id="parameters-misconfiguration"><a class="header" href="#parameters-misconfiguration">Parameters misconfiguration</a></h3>
<ul>
<li>High <code>surplusDelay</code> slows surplus actions.</li>
<li>Low <code>surplusDelay</code> rushes surplus auctions.</li>
<li>High <code>popDebtDelay</code> delays debt auctions.</li>
<li>Low <code>popDebtDelay</code> risks double debt coverage.</li>
<li>High <code>surplusAmount</code> risks unfilled surplus auctions.</li>
<li>Low <code>surplusAmount</code> hampers surplus actions.</li>
<li>High <code>surplusBuffer</code> blocks surplus auctions.</li>
<li>Low <code>surplusBuffer</code> risks uncovered new debt.</li>
<li>High <code>debtAuctionMintedTokens</code> dilutes protocol tokens.</li>
<li>Low <code>debtAuctionMintedTokens</code> risks failed debt auctions.</li>
<li>High <code>debtAuctionBidSize</code> risks unfilled debt auctions.</li>
<li>Low <code>debtAuctionBidSize</code> slows debt auctions.</li>
<li>Low <code>shutdownCooldown</code> risks premature surplus moves.</li>
<li>High <code>shutdownCooldown</code> delays post-shutdown surplus actions.</li>
</ul>
<h3 id="post-settlement-surplus-drain-misconfiguration"><a class="header" href="#post-settlement-surplus-drain-misconfiguration">Post Settlement Surplus Drain misconfiguration</a></h3>
<p>The <code>postSettlementSurplusDrain</code> address should be configured after the system is deployed. It's permissible to leave it unset, but doing so comes with implications: if Global Settlement is activated while this address is not specified, any surplus remaining after the settlement won't be drained. Instead, this surplus can only be used for debt elimination. It's worth noting that once Global Settlement is triggered, the address for <code>postSettlementSurplusDrain</code> becomes immutable and can't be changed.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../detailed/modules/safe_engine.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../../detailed/modules/liq_engine.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../detailed/modules/safe_engine.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../../detailed/modules/liq_engine.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
